name: train-house-prices
description: Train XGBoost model on synthetic house prices data

outputs:
  - {name: model_path, type: String}
  - {name: predictions_path, type: String}
  - {name: training_script_path, type: String}
  - {name: readme_path, type: String}

implementation:
  container:
    image: python:3.11-slim
    command:
      - sh
      - -c
      - |
        pip install pandas xgboost scikit-learn && python - <<'EOF'
        import pandas as pd
        import xgboost as xgb
        from sklearn.model_selection import train_test_split
        from sklearn.datasets import make_regression
        import pickle
        import os

        # Create output directory
        os.makedirs('/outputs', exist_ok=True)

        # Generate synthetic data
        X, y = make_regression(n_samples=1000, n_features=10, noise=10, random_state=42)
        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

        # Convert to DataFrame
        feature_names = [f'feature_{i}' for i in range(X.shape[1])]
        X_train_df = pd.DataFrame(X_train, columns=feature_names)
        X_test_df = pd.DataFrame(X_test, columns=feature_names)

        # Train model
        model = xgb.XGBRegressor(n_estimators=100, max_depth=7, learning_rate=0.1, random_state=42)
        model.fit(X_train_df, y_train)

        # Evaluate
        train_score = model.score(X_train_df, y_train)
        test_score = model.score(X_test_df, y_test)
        print(f"Training R² score: {train_score:.4f}")
        print(f"Test R² score: {test_score:.4f}")

        # Save model
        model_path = '/outputs/model.pkl'
        with open(model_path, 'wb') as f:
            pickle.dump(model, f)

        # Generate predictions
        predictions = model.predict(X_test_df)
        predictions_path = '/outputs/predictions.csv'
        pred_df = pd.DataFrame({'Id': range(len(predictions)), 'Prediction': predictions})
        pred_df.to_csv(predictions_path, index=False)

        # Save training script
        training_script_path = '/outputs/train.py'
        with open(training_script_path, 'w') as f:
            f.write("""# Training Script

        This model was trained using XGBoost on synthetic regression data.

        ## Training Configuration
        - Algorithm: XGBoost Gradient Boosting
        - n_estimators: 100
        - max_depth: 7
        - learning_rate: 0.1
        - random_state: 42

        ## Data
        - Training samples: 800
        - Test samples: 200
        - Features: 10 (synthetic)
        """)

        # Generate README
        readme_path = '/outputs/README.md'
        with open(readme_path, 'w') as f:
            f.write(f"""# House Prices Demo Model

        ## Model Details
        - **Framework**: XGBoost {xgb.__version__}
        - **Algorithm**: Gradient Boosted Trees
        - **Training R² Score**: {train_score:.4f}
        - **Test R² Score**: {test_score:.4f}

        ## Training Data
        - Training samples: {len(X_train)}
        - Test samples: {len(X_test)}
        - Features: {X.shape[1]} (synthetic)

        ## Usage
        ```python
        import pickle
        with open('model.pkl', 'rb') as f:
            model = pickle.load(f)
        predictions = model.predict(X_new)
        ```

        ---
        Packaged with KitOps
        """)

        # Create KFP outputs directory
        os.makedirs('/tmp/kfp/outputs', exist_ok=True)

        # Write output paths for KFP
        with open('/tmp/kfp/outputs/model_path', 'w') as f:
            f.write(model_path)
        with open('/tmp/kfp/outputs/predictions_path', 'w') as f:
            f.write(predictions_path)
        with open('/tmp/kfp/outputs/training_script_path', 'w') as f:
            f.write(training_script_path)
        with open('/tmp/kfp/outputs/readme_path', 'w') as f:
            f.write(readme_path)
        EOF
    fileOutputs:
      model_path: /tmp/kfp/outputs/model_path
      predictions_path: /tmp/kfp/outputs/predictions_path
      training_script_path: /tmp/kfp/outputs/training_script_path
      readme_path: /tmp/kfp/outputs/readme_path
